name: British Airways Transformation Job

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
  schedule:
  - cron: '0 0 * * 1' # Runs every Monday at 00:00 UTC
  workflow_dispatch:


env:
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
  SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

jobs:
  skytrax_transformation:
    runs-on: ubuntu-latest

    steps:
      # 0Ô∏è‚É£ Get current timestamp for reporting in the notification email
      - name: Get current timestamp
        id: timestamp
        run: echo "time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      # 1Ô∏è‚É£ Checkout the repository code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python 3.12 for the environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # 3Ô∏è‚É£ Install Python dependencies from requirements.txt
      - name: Install requirements
        run: pip install -r requirements.txt

      # 4Ô∏è‚É£ Install dbt dependencies defined in packages.yml
      - name: Install dbt dependencies
        working-directory: ./skytrax_transformation
        run: dbt deps

      # 5Ô∏è‚É£ Test dbt connection to Snowflake (or target warehouse) using dbt debug
      - name: Testing connection
        working-directory: ./skytrax_transformation
        run: dbt debug

      # 6Ô∏è‚É£ Run dbt build to execute all models, tests, and snapshots
      - name: Run dbt build
        working-directory: ./skytrax_transformation
        run: dbt build --exclude dim_date --profiles-dir ./ --select staging+

      # 7Ô∏è‚É£ Send an email notification about the workflow status (always runs)
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Skytrax Transformation Job - ${{ job.status }}"
          to: minh.b.pham@tcu.edu
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            ‚úàÔ∏è Skytrax Transformation Job Report ‚úàÔ∏è

            The workflow has completed.

            üìÖ Run Time: ${{ steps.timestamp.outputs.time }}
            üîÑ Triggered by: ${{ github.event_name }}
            ‚úÖ Status: ${{ job.status }}

            üìÇ Repository: ${{ github.repository }}
            üîó Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Cheers,  
            GitHub Actions ü§ñ
