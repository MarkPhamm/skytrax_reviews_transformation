version: 2

models:
  - name: fct_review
    description: This table contains detailed review information including customer, dates, locations, aircraft, and review metrics.
    columns:
      - name: review_id
        description: Unique identifier for each review.
        tests:
          - unique
          - not_null

        config:
          meta:
            datatypes: integer
      - name: customer_id
        description: Unique identifier for each customer.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_customer')
                field: customer_id

        config:
          meta:
            datatypes: integer
      - name: date_submitted_id
        description: Unique identifier for the date the review was submitted.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

        config:
          meta:
            datatypes: integer
      - name: date_flown_id
        description: Unique identifier for the date the flight was taken.
        tests:
    # - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

        config:
          meta:
            datatypes: integer
      - name: origin_location_id
        description: Unique identifier for the origin location.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_location')
                field: location_id

        config:
          meta:
            datatypes: integer
      - name: destination_location_id
        description: Unique identifier for the destination location.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_location')
                field: location_id

        config:
          meta:
            datatypes: integer
      - name: transit_location_id
        description: Unique identifier for the transit location.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_location')
                field: location_id

        config:
          meta:
            datatypes: integer
      - name: aircraft_id
        description: Unique identifier for the aircraft.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_aircraft')
                field: aircraft_id

        config:
          meta:
            datatypes: integer
      - name: verified
        description: Indicates if the review is verified.
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

        config:
          meta:
            datatypes: boolean
      - name: seat_type
        description: The type of seat in the review.
        tests:
          - accepted_values:
              arguments:
                values: ['Premium Economy', 'Business Class', 'Economy Class', 'First Class']

        config:
          meta:
            datatypes: string
      - name: type_of_traveller
        description: The type of traveller in the review.
        tests:
          - accepted_values:
              arguments:
                values: ['Business', 'Couple Leisure', 'Family Leisure', 'Solo Leisure', null]

        config:
          meta:
            datatypes: string
      - name: seat_comfort
        description: Rating for seat comfort.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 1
                max_value: 5
        config:
          meta:
            datatypes: integer
      - name: cabin_staff_service
        description: Rating for cabin staff service.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 1
                max_value: 5
        config:
          meta:
            datatypes: integer
      - name: food_and_beverages
        description: Rating for food and beverages.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 1
                max_value: 5
        config:
          meta:
            datatypes: integer
      - name: inflight_entertainment
        description: Rating for inflight entertainment.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 1
                max_value: 5
        config:
          meta:
            datatypes: integer
      - name: ground_service
        description: Rating for ground service.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 1
                max_value: 5
        config:
          meta:
            datatypes: integer
      - name: wifi_and_connectivity
        description: Rating for wifi and connectivity.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 1
                max_value: 5
        config:
          meta:
            datatypes: integer
      - name: value_for_money
        description: Rating for value for money.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 1
                max_value: 5
        config:
          meta:
            datatypes: integer
      - name: recommended
        description: Indicates if the reviewer recommends the airline.
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

        config:
          meta:
            datatypes: boolean
      - name: review_text
        description: The text of the review.
        config:
          meta:
            datatypes: string
      - name: el_updated_at
        description: Timestamp indicating when the record was last updated from the EL pipeline
        tests:
          - not_null

        config:
          meta:
            datatypes: timestamp
      - name: t_updated_at
        description: Timestamp indicating when the record was last updated from the Transformation pipeline
        tests:
          - not_null

        config:
          meta:
            datatypes: timestamp
    config:
      meta:
        contracts:
          enabled: true
# -----------------------------------------------------------------------------------------------------
  - name: fct_review_enriched
    description: |
      Enriched review fact table. Adds the calculated average rating across the
      seven sub-rating metrics and a categorical rating band. All other columns
      are identical to fct_review.
    columns:
  # --- keys and foreign-keys (unchanged) ---
      - name: review_id
        description: Unique identifier for each review.
        tests: [unique, not_null]
        config:
          meta:
            datatypes: integer

      - name: customer_id
        description: Unique identifier for each customer.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_customer')
                field: customer_id

        config:
          meta:
            datatypes: integer
      - name: date_submitted_id
        description: Unique identifier for the date the review was submitted.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

        config:
          meta:
            datatypes: integer
      - name: date_flown_id
        description: Unique identifier for the date the flight was taken.
        tests:
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

        config:
          meta:
            datatypes: integer
      - name: origin_location_id
        description: Unique identifier for the origin location.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_location')
                field: location_id

        config:
          meta:
            datatypes: integer
      - name: destination_location_id
        description: Unique identifier for the destination location.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_location')
                field: location_id

        config:
          meta:
            datatypes: integer
      - name: transit_location_id
        description: Unique identifier for the transit location.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_location')
                field: location_id

        config:
          meta:
            datatypes: integer
      - name: aircraft_id
        description: Unique identifier for the aircraft.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_aircraft')
                field: aircraft_id

  # --- attributes (unchanged) ---
        config:
          meta:
            datatypes: integer
      - name: verified
        description: Indicates if the review is verified.
        tests:
          - accepted_values: {arguments: {values: [true, false]}}

        config:
          meta:
            datatypes: boolean
      - name: seat_type
        description: The type of seat in the review.
        tests:
          - accepted_values:
              arguments:
                values: ['Premium Economy', 'Business Class', 'Economy Class', 'First Class']

        config:
          meta:
            datatypes: string
      - name: type_of_traveller
        description: The type of traveller in the review.
        tests:
          - accepted_values:
              arguments:
                values: ['Business', 'Couple Leisure', 'Family Leisure', 'Solo Leisure', null]

  # --- sub-ratings (unchanged) ---
        config:
          meta:
            datatypes: string
      - name: seat_comfort
        description: Rating for seat comfort.
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 1, max_value: 5}}

        config:
          meta:
            datatypes: integer
      - name: cabin_staff_service
        description: Rating for cabin staff service.
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 1, max_value: 5}}

        config:
          meta:
            datatypes: integer
      - name: food_and_beverages
        description: Rating for food and beverages.
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 1, max_value: 5}}

        config:
          meta:
            datatypes: integer
      - name: inflight_entertainment
        description: Rating for inflight entertainment.
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 1, max_value: 5}}

        config:
          meta:
            datatypes: integer
      - name: ground_service
        description: Rating for ground service.
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 1, max_value: 5}}

        config:
          meta:
            datatypes: integer
      - name: wifi_and_connectivity
        description: Rating for wifi and connectivity.
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 1, max_value: 5}}

        config:
          meta:
            datatypes: integer
      - name: value_for_money
        description: Rating for value for money.
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 1, max_value: 5}}

        config:
          meta:
            datatypes: integer
      - name: recommended
        description: Indicates if the reviewer recommends the airline.
        tests:
          - accepted_values: {arguments: {values: [true, false]}}

  # --- new calculated columns ---
        config:
          meta:
            datatypes: boolean
      - name: average_rating
        description: >
          Mean of the seven sub-ratings, computed across non-null values. Range 0–5; null if all sub-ratings are null. Round to 2 decimals
        tests:
          - dbt_expectations.expect_column_values_to_be_between: {arguments: {min_value: 0, max_value: 5}}

        config:
          meta:
            datatypes: numeric
      - name: rating_band
        description: >
          Categorical band derived from average_rating: 0–<2 → bad, 2–<4 → medium, 4–5 → good. 'Unknown' if average_rating is null.
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['bad', 'medium', 'good', 'Unknown']
  # --- end of new metrics ------

        config:
          meta:
            datatypes: string
      - name: review_text
        description: The text of the review.
        config:
          meta:
            datatypes: string
      - name: el_updated_at
        description: Timestamp indicating when the record was last updated from the EL pipeline.
        tests: [not_null]
        config:
          meta:
            datatypes: timestamp

      - name: t_updated_at
        description: Timestamp indicating when the record was last updated from the Transformation pipeline.
        tests: [not_null]
        config:
          meta:
            datatypes: timestamp

    config:
      meta:
        contracts:
          enabled: true
# -----------------------------------------------------------------------------------------------------
  - name: dim_location
    description: This table contains distinct locations (city and airport) derived from the reviews.
    columns:
      - name: location_id
        description: Unique identifier for each location.
        tests:
          - unique
          - not_null

        config:
          meta:
            datatypes: integer
      - name: city
        description: The city of the location.
        tests:
          - not_null

        config:
          meta:
            datatypes: string
      - name: airport
        description: The airport of the location.
        tests:
          - not_null

        config:
          meta:
            datatypes: string
    config:
      meta:
        contracts:
          enabled: true

# -----------------------------------------------------------------------------------------------------
  - name: dim_date
    description: This table contains a date dimension starting from 2015-01-01.
    columns:
      - name: date_id
        description: Surrogate key representing each calendar date.
        tests:
          - unique
          - not_null
        config:
          meta:
            datatypes: integer
      - name: day_of_week
        description: Numeric day of the week (e.g., 1 = Monday).
        config:
          meta:
            datatypes: integer
      - name: day_of_week_name
        description: Name of the day of the week.
        config:
          meta:
            datatypes: string
      - name: cal_week_start_date
        description: Start date of the calendar week (usually Monday).
        config:
          meta:
            datatypes: date
      - name: day_of_month
        description: Day of the month.
        config:
          meta:
            datatypes: integer
      - name: cal_month
        description: Calendar month as integer (1-12).
        config:
          meta:
            datatypes: integer
      - name: cal_mon_name
        description: Full name of the calendar month.
        config:
          meta:
            datatypes: string
      - name: cal_mon_name_short
        description: Abbreviated name of the calendar month.
        config:
          meta:
            datatypes: string
      - name: cal_quarter
        description: Calendar quarter number.
        config:
          meta:
            datatypes: integer
      - name: cal_quarter_name
        description: Name of the calendar quarter (e.g., Q1).
        config:
          meta:
            datatypes: string
      - name: cal_year
        description: Calendar year.
        config:
          meta:
            datatypes: integer
      - name: is_weekend
        description: Indicates if the date falls on a weekend.
        tests:
          - accepted_values:
              arguments:
                values: [true, false]
        config:
          meta:
            datatypes: boolean
      - name: fin_year
        description: Financial year associated with the date.
        config:
          meta:
            datatypes: integer
      - name: fin_period
        description: Financial period number.
        config:
          meta:
            datatypes: integer
      - name: fin_quarter
        description: Financial quarter number.
        config:
          meta:
            datatypes: integer
      - name: fin_week
        description: Financial week number.
        config:
          meta:
            datatypes: integer
      - name: fin_period_name
        description: Name of the financial period.
        config:
          meta:
            datatypes: string
      - name: fin_quarter_name
        description: Name of the financial quarter.
        config:
          meta:
            datatypes: string
      - name: fin_week_name
        description: Name of the financial week.
        config:
          meta:
            datatypes: string
    config:
      meta:
        contracts:
          enabled: true
# -----------------------------------------------------------------------------------------------------
  - name: dim_aircraft
    description: This table contains distinct aircraft models and their details derived from the reviews.
    columns:
      - name: aircraft_id
        description: Unique identifier for each aircraft.
        tests:
          - unique
          - not_null

        config:
          meta:
            datatypes: integer
      - name: aircraft_model
        description: The model of the aircraft.
        tests:
          - not_null

        config:
          meta:
            datatypes: string
      - name: aircraft_manufacturer
        description: The manufacturer of the aircraft.
        config:
          meta:
            datatypes: string
      - name: seat_capacity
        description: The seating capacity of the aircraft.
        config:
          meta:
            datatypes: integer
    config:
      meta:
        contracts:
          enabled: true

# -----------------------------------------------------------------------------------------------------
  - name: dim_customer
    description: This table contains distinct customers derived from the reviews.
    columns:
      - name: customer_id
        description: Unique identifier for each customer.
        tests:
          - unique
          - not_null

        config:
          meta:
            datatypes: integer
      - name: customer_name
        description: The name of the customer.
        tests:
          - not_null:
              config:
                severity: warn
                error_if: ">5"
                warn_if: ">0"

        config:
          meta:
            datatypes: string
      - name: nationality
        description: The nationality of the customer.
        config:
          meta:
            datatypes: string
      - name: number_of_flights
        description: The number of flights taken by the customer.
        config:
          meta:
            datatypes: integer
    config:
      meta:
        contracts:
          enabled: true